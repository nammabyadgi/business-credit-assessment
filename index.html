<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Credit Assessment Tool</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">

    <style>
        :root {
            --color-primary: #208791;
            --color-primary-hover: #1a6b74;
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-bg: #f8fafc;
            --color-surface: #ffffff;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --color-border: #e2e8f0;
            --color-divider: #cbd5e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, #1a6b74 100%);
            color: white;
            padding: 40px 20px;
            border-radius: 12px;
            margin-bottom: 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        header p {
            font-size: 16px;
            opacity: 0.95;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--color-border);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--color-text);
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(32, 135, 145, 0.1);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        input[type="file"] {
            display: none;
        }

        .file-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background-color: var(--color-bg);
            border: 2px dashed var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            color: var(--color-primary);
            font-weight: 500;
        }

        .file-button:hover {
            border-color: var(--color-primary);
            background-color: rgba(32, 135, 145, 0.05);
        }

        .file-button.has-file {
            border-style: solid;
            background-color: rgba(34, 197, 94, 0.05);
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(32, 135, 145, 0.3);
        }

        .btn-secondary {
            background-color: var(--color-bg);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background-color: var(--color-border);
        }

        .btn-primary:disabled {
            background-color: #cbd5e1;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Section */
        .results-section {
            margin-top: 40px;
        }

        .score-display {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--color-border);
            margin-bottom: 30px;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 700;
            color: white;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .score-circle.excellent {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .score-circle.good {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .score-circle.fair {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .score-circle.poor {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .score-label {
            font-size: 18px;
            color: var(--color-text-secondary);
            margin-top: 15px;
        }

        .pd-metric {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-top: 20px;
        }

        .recommendation {
            background: var(--color-bg);
            border-left: 4px solid var(--color-primary);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 15px;
            font-weight: 500;
        }

        .recommendation.credit {
            border-left-color: var(--color-success);
            background-color: rgba(34, 197, 94, 0.05);
            color: #166534;
        }

        .recommendation.spot {
            border-left-color: var(--color-error);
            background-color: rgba(239, 68, 68, 0.05);
            color: #7f1d1d;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .metric-card {
            background: var(--color-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .metric-card h3 {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-card .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .metric-card .value.high {
            color: var(--color-error);
        }

        .metric-card .value.medium {
            color: var(--color-warning);
        }

        .metric-card .value.low {
            color: var(--color-success);
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .details-table th {
            background-color: var(--color-bg);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            border-bottom: 2px solid var(--color-border);
        }

        .details-table td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .details-table tr:hover {
            background-color: var(--color-bg);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.verified {
            background-color: rgba(34, 197, 94, 0.15);
            color: #166534;
        }

        .badge.pending {
            background-color: rgba(245, 158, 11, 0.15);
            color: #92400e;
        }

        .badge.missing {
            background-color: rgba(239, 68, 68, 0.15);
            color: #7f1d1d;
        }

        .help-text {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-top: 6px;
        }

        .required {
            color: var(--color-error);
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--color-border);
        }

        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--color-text-secondary);
            transition: all 0.3s;
            font-size: 14px;
        }

        .tab-button.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--color-error);
            color: #7f1d1d;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .success-message {
            background-color: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--color-success);
            color: #166534;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        .footer {
            text-align: center;
            padding: 30px 20px;
            color: var(--color-text-secondary);
            font-size: 13px;
            margin-top: 40px;
            border-top: 1px solid var(--color-border);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¢ Business Credit Assessment Tool</h1>
            <p>Evaluate supplier creditworthiness and probability of default (PD) for informed credit decisions</p>
        </header>

        <div id="formContainer" class="main-grid">
            <!-- Left Column: Personal & Contact Details -->
            <div class="card">
                <h2>üë§ Personal & Contact Details</h2>
                
                <div class="form-group">
                    <label>Contact Person Name <span class="required">*</span></label>
                    <input type="text" id="contactName" placeholder="Full name of contact person" />
                </div>

                <div class="form-group">
                    <label>Mobile Number <span class="required">*</span></label>
                    <input type="tel" id="mobileNumber" placeholder="10-digit mobile number" />
                    <div class="help-text">Required field for verification</div>
                </div>

                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="email" placeholder="email@business.com" />
                </div>

                <div class="form-group">
                    <label>Upload Visiting Card / ID Proof</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="visitingCard" accept=".pdf,.jpg,.jpeg,.png" />
                        <div class="file-button" onclick="document.getElementById('visitingCard').click()">
                            üìé Choose file or drag & drop
                        </div>
                    </div>
                    <div class="help-text">PDF, JPG, or PNG (max 5MB)</div>
                </div>

                <div class="form-group">
                    <label>Upload Profile Photo</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="profilePhoto" accept=".jpg,.jpeg,.png" />
                        <div class="file-button" onclick="document.getElementById('profilePhoto').click()">
                            üì∑ Choose file or drag & drop
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Business Details -->
            <div class="card">
                <h2>üè™ Business Details</h2>

                <div class="form-group">
                    <label>Business Name / Trade Name <span class="required">*</span></label>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <input type="text" id="businessName" placeholder="Name of the business" />
                        </div>
                        <button type="button" class="btn-secondary" onclick="autoFillFromPerplexity()" style="padding: 12px 16px; white-space: nowrap;">
                            üîç AI Search
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>GST Number <span class="required">*</span></label>
                    <input type="text" id="gstNumber" placeholder="15-digit GST number (e.g., 29CGHPP7700B1ZG)" />
                    <div class="help-text">Required for verification</div>
                </div>

                <div class="form-group">
                    <label>Upload GST Certificate</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="gstCertificate" accept=".pdf,.jpg,.jpeg,.png" />
                        <div class="file-button" onclick="document.getElementById('gstCertificate').click()">
                            üìÑ Choose file or drag & drop
                        </div>
                    </div>
                    <div class="help-text">PDF or image of GST registration certificate</div>
                </div>

                <div class="form-group">
                    <label>Years in Business</label>
                    <input type="text" id="yearsInBusiness" placeholder="e.g., 5" />
                </div>

                <div class="form-group">
                    <label>Annual Turnover (‚Çπ)</label>
                    <input type="text" id="annualTurnover" placeholder="e.g., 50,00,000" />
                </div>
            </div>
        </div>

        <!-- Second Row: Verification & Documents -->
        <div class="main-grid">
            <!-- Bank Details -->
            <div class="card">
                <h2>üè¶ Bank Details (Optional)</h2>

                <div class="form-group">
                    <label>Bank Name</label>
                    <input type="text" id="bankName" placeholder="e.g., HDFC Bank" />
                </div>

                <div class="form-group">
                    <label>Account Holder Name</label>
                    <input type="text" id="accountHolderName" placeholder="Name on bank account" />
                </div>

                <div class="form-group">
                    <label>Account Type</label>
                    <select id="accountType">
                        <option value="">Select account type</option>
                        <option value="savings">Savings</option>
                        <option value="current">Current</option>
                        <option value="business">Business</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Upload Bank Statement</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="bankStatement" accept=".pdf" />
                        <div class="file-button" onclick="document.getElementById('bankStatement').click()">
                            üìä Choose file or drag & drop
                        </div>
                    </div>
                    <div class="help-text">Last 3-6 months bank statement (PDF)</div>
                </div>
            </div>

            <!-- Online Presence & References -->
            <div class="card">
                <h2>üåê Online Presence & Reviews</h2>

                <div class="form-group">
                    <label>IndiaMART Profile Link</label>
                    <input type="text" id="indiaMartLink" placeholder="https://indiamart.com/company-profile" />
                    <div class="help-text">Link to IndiaMART seller profile</div>
                </div>

                <div class="form-group">
                    <label>Google Business Profile / Maps Link</label>
                    <input type="text" id="googleBusinessLink" placeholder="https://maps.google.com/..." />
                </div>

                <div class="form-group">
                    <label>Average Rating (if available)</label>
                    <input type="text" id="averageRating" placeholder="e.g., 4.5" />
                </div>

                <div class="form-group">
                    <label>Key References / Certifications</label>
                    <textarea id="references" placeholder="List any certifications, awards, or reference businesses..."></textarea>
                </div>
            </div>
        </div>

        <!-- Submit Buttons -->
        <div class="button-group">
            <button class="btn-primary" onclick="calculateScore()">üìä Calculate Credit Score</button>
            <button class="btn-secondary" onclick="resetForm()">üîÑ Reset Form</button>
        </div>

        <!-- Results Section -->
        <div id="resultsContainer" style="display: none;" class="results-section">
            <div class="score-display">
                <div class="score-circle" id="scoreCircle">0</div>
                <p class="score-label" id="scoreLabel">Score</p>
                <p class="pd-metric">PD (Probability of Default): <span id="pdScore">0%</span></p>
                <div id="recommendation" class="recommendation" style="display: none;"></div>
            </div>

            <div class="card">
                <h2>üìà Detailed Assessment</h2>
                
                <div class="tabs">
                    <button class="tab-button active" onclick="switchTab(0)">Overview</button>
                    <button class="tab-button" onclick="switchTab(1)">Score Breakdown</button>
                    <button class="tab-button" onclick="switchTab(2)">Documentation</button>
                    <button class="tab-button" onclick="switchTab(3)">Recommendation</button>
                </div>

                <!-- Tab 1: Overview -->
                <div id="tab0" class="tab-content active">
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Assessment</th>
                            </tr>
                        </thead>
                        <tbody id="overviewTable">
                        </tbody>
                    </table>
                </div>

                <!-- Tab 2: Score Breakdown -->
                <div id="tab1" class="tab-content">
                    <div class="metrics-grid" id="metricsBreakdown">
                    </div>
                </div>

                <!-- Tab 3: Documentation -->
                <div id="tab2" class="tab-content">
                    <table class="details-table">
                        <thead>
                            <tr>
                                <th>Document</th>
                                <th>Status</th>
                                <th>Impact on Score</th>
                            </tr>
                        </thead>
                        <tbody id="documentationTable">
                        </tbody>
                    </table>
                </div>

                <!-- Tab 4: Recommendation -->
                <div id="tab3" class="tab-content">
                    <div id="detailedRecommendation"></div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>‚ö†Ô∏è <strong>Disclaimer:</strong> This tool is for assessment purposes only. Final credit decisions should consider additional factors and comply with your business policies and regulatory requirements.</p>
            <p style="margin-top: 10px;">¬© 2025 Namma Byadgi - Business Assessment Tool</p>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL FLAGS & CONFIGURATION
        // ============================================
        let isSearching = false; // Prevent duplicate AI searches
        
        // ============================================
        // PERPLEXITY API CONFIGURATION (FREE)
        // ============================================
        // Using Perplexity's free tier via sonar API
        // No API key required - uses public endpoints
        // Rate limit: Generous for assessment use
        
        // Helper function to extract business info using Perplexity
        async function fetchBusinessDataWithPerplexity(businessName, gstNumber = '', city = 'India') {
            try {
                showLoadingSpinner('üîç Searching for business data...');
                
                // Query 1: Search for business on IndiaMART + Google + social media
const searchQuery = `
Find verified business information for "${businessName}" in India.

Rules:
- Use only publicly available internet sources
- Do NOT guess GST numbers
- If GST not found online, return null
- Include social media only if official

Return STRICT JSON only:
{
  "business_name": "",
  "gst_number": "",
  "indiamart_url": "",
  "google_maps_url": "",
  "website": "",
  "facebook_url": "",
  "linkedin_url": "",
  "google_rating": "",
  "reviews_summary": "",
  "confidence": 0,
  "sources": []
}
`;


                
                const businessData = await queryBackendAI(searchQuery);

// üö® If business is found, DO NOT block UI for extras
let sentimentData = null;
let gstValidation = null;

try {
    if (businessData && businessData.reviews_summary) {
        sentimentData = await queryBackendAI(sentimentQuery, 15000);
    }
} catch (e) {
    console.warn('Sentiment skipped:', e.message);
}

try {
    if (gstNumber && gstNumber.length === 15) {
        gstValidation = await queryBackendAI(gstQuery, 15000);
    }
} catch (e) {
    console.warn('GST validation skipped:', e.message);
}

return {
    businessData,
    sentimentData,
    gstValidation,
    timestamp: new Date().toISOString()
};

                
            } catch (error) {
                console.error('Error fetching from Perplexity:', error);
                hideLoadingSpinner();
                return null;
            }
        }


async function queryBackendAI(prompt, timeoutMs = 30000) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

  try {
    const body = `prompt=${encodeURIComponent(prompt)}`;

    const response = await fetch(
      'https://script.google.com/macros/s/AKfycbxwXCKWOEzgL-B-5ACjWYKJIPRBe4sH5-1tOL5PeIIdoKm18IYjNTGCFlU0t150F487/exec',
      {
        method: 'POST',
        body,
        signal: controller.signal
      }
    );

    const text = await response.text();
    const data = JSON.parse(text);

    if (!data.success) {
      throw new Error(data.error || 'Backend error');
    }

    // Extract strict JSON from Perplexity response
    const match = data.result.match(/\{[\s\S]*\}/);
    if (!match) {
      throw new Error('No structured data returned');
    }

    return JSON.parse(match[0]);

  } catch (err) {
    if (err.name === 'AbortError') {
      throw new Error('AI_TIMEOUT');
    }
    throw err;
  } finally {
    clearTimeout(timeoutId);
  }
}




        
        
        
        // Extract data from natural language response
        function parseBusinessResponse(response) {
            if (!response) return null;
            
            return {
                indiamart_rating: extractRating(response, 'indiamart|rating'),
                google_rating: extractRating(response, 'google|rating|stars'),
                has_facebook: checkPresence(response, 'facebook'),
                has_linkedin: checkPresence(response, 'linkedin'),
                has_website: checkPresence(response, 'website|web'),
                reviews_count: extractNumber(response, 'review'),
                business_age: extractNumber(response, 'year|established'),
                verification_status: checkVerification(response)
            };
        }
        
        function extractRating(text, keywords) {
            const regex = new RegExp(`(${keywords}).*?(\\d+\\.?\\d*)`, 'i');
            const match = text.match(regex);
            return match ? parseFloat(match[2]) : 0;
        }
        
        function extractNumber(text, keyword) {
            const regex = new RegExp(`(${keyword}).*?(\\d+)`, 'i');
            const match = text.match(regex);
            return match ? parseInt(match[2]) : 0;
        }
        
        function checkPresence(text, keywords) {
            const regex = new RegExp(`(${keywords})`, 'i');
            return regex.test(text);
        }
        
        function checkVerification(text) {
            if (text.toLowerCase().includes('verified')) return 'Verified';
            if (text.toLowerCase().includes('unverified')) return 'Unverified';
            return 'Pending';
        }

        // ============================================
        // HELPER FUNCTIONS: TOAST & SPINNER
        // ============================================
        function showToast(message, type = 'info') {
            // Remove existing toast
            const existing = document.getElementById('toastNotification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.id = 'toastNotification';
            
            // Color by type
            let bgColor = '#3b82f6'; // blue
            if (type === 'error') bgColor = '#ef4444';
            if (type === 'success') bgColor = '#22c55e';
            if (type === 'warning') bgColor = '#f59e0b';
            if (type === 'loading') bgColor = '#208791';
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Auto-remove (except loading)
            if (type !== 'loading') {
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.style.animation = 'slideOut 0.3s ease-out';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 5000);
            }
        }
        
        function showLoadingSpinner(message = 'üîÑ Loading...') {
            const existing = document.getElementById('loadingSpinner');
            if (existing) existing.remove();
            
            const div = document.createElement('div');
            div.id = 'loadingSpinner';
            div.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(32, 135, 145, 0.95);
                color: white;
                padding: 40px;
                border-radius: 12px;
                z-index: 9999;
                text-align: center;
                font-size: 18px;
                font-weight: 600;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            div.innerHTML = `${message}<br><small style="opacity: 0.8;">Please wait...</small>`;
            document.body.appendChild(div);
        }
        
        function hideLoadingSpinner() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) spinner.remove();
        }

        // Inject animation styles (run once)
        if (!document.getElementById('toastStyles')) {
            const style = document.createElement('style');
            style.id = 'toastStyles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(400px); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(400px); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // ============================================
        // FILE UPLOAD HANDLING
        // ============================================
        const fileInputs = ['visitingCard', 'profilePhoto', 'gstCertificate', 'bankStatement'];
        
        fileInputs.forEach(inputId => {
            const fileInput = document.getElementById(inputId);
            
            const fileButton = fileInput.parentElement.querySelector('.file-button');
            if (!fileInput || !fileButton) return;  // Skip if element doesn't exist
            
            fileInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    fileButton.textContent = '‚úì ' + this.files[0].name;
                    fileButton.classList.add('has-file');
                }
            });
            
            fileButton.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileButton.style.backgroundColor = 'rgba(32, 135, 145, 0.1)';
            });
            
            fileButton.addEventListener('dragleave', () => {
                fileButton.style.backgroundColor = '';
            });
            
            fileButton.addEventListener('drop', (e) => {
                e.preventDefault();
                fileButton.style.backgroundColor = '';
                fileInput.files = e.dataTransfer.files;
                if (fileInput.files && fileInput.files[0]) {
                    fileButton.textContent = '‚úì ' + fileInput.files[0].name;
                    fileButton.classList.add('has-file');
                }
            });
        });

        // ============================================
        // AUTO-FILL FROM PERPLEXITY AI SEARCH
        // ============================================
        
        async function autoFillFromPerplexity() {
            // Prevent duplicate clicks
            if (isSearching) {
                showToast('‚è≥ Search already in progress...', 'warning');
                return;
            }
            
            const businessName = document.getElementById('businessName').value.trim();
            
            if (!businessName) {
                showToast('‚ùå Please enter business name first', 'error');
                return;
            }
            
            isSearching = true;
            showLoadingSpinner('üîç Verifying business from internet sources‚Ä¶');


            
            try {
                // Fetch comprehensive business data
                const result = await fetchBusinessDataWithPerplexity(businessName);
                
                if (!result) {
    showToast('‚ö†Ô∏è Verification failed. Please retry.', 'warning');
    return;
}

if (!result.businessData) {
    showToast('‚ö†Ô∏è No public data found for this business.', 'warning');
    return;
}

if (!result.businessData.business_name) {
    showToast('‚ö†Ô∏è Business not found in public sources.', 'warning');
    return;
}

                
            } catch (error) {
                console.error('Search error:', error);
                showToast('‚ùå Search error. Please retry.', 'error');
            } finally {
                isSearching = false;
            }
        }

        // Core scoring algorithm
        function calculateScore() {
            const contactName = document.getElementById('contactName').value.trim();
            const mobileNumber = document.getElementById('mobileNumber').value.trim();
            const businessName = document.getElementById('businessName').value.trim();
            const gstNumber = document.getElementById('gstNumber').value.trim();

            // Validation
            if (!contactName) {
                alert('‚ùå Please enter contact person name');
                return;
            }
            if (!mobileNumber || mobileNumber.length < 10) {
                alert('‚ùå Please enter valid 10-digit mobile number');
                return;
            }
            if (!businessName) {
                alert('‚ùå Please enter business name');
                return;
            }
            if (!gstNumber) {
                alert('‚ùå Please enter GST number');
                return;
            }

            // Score calculation
            let baseScore = 50;
            let scoreBreakdown = {
                documentVerification: 0,
                gstVerification: 0,
                bankDetails: 0,
                onlinePresence: 0,
                businessHistory: 0
            };

            // 1. Document Verification (25 points)
            if (document.getElementById('visitingCard').files.length > 0) scoreBreakdown.documentVerification += 8;
            if (document.getElementById('profilePhoto').files.length > 0) scoreBreakdown.documentVerification += 8;
            if (document.getElementById('gstCertificate').files.length > 0) scoreBreakdown.documentVerification += 9;

            // 2. GST Verification (20 points)
            if (gstNumber.length === 15) scoreBreakdown.gstVerification += 20;
            else if (gstNumber.length > 0) scoreBreakdown.gstVerification += 10;

            // 3. Bank Details (20 points)
            if (document.getElementById('bankName').value.trim()) scoreBreakdown.bankDetails += 7;
            if (document.getElementById('accountHolderName').value.trim()) scoreBreakdown.bankDetails += 7;
            if (document.getElementById('bankStatement').files.length > 0) scoreBreakdown.bankDetails += 6;

            // 4. Online Presence (20 points) - Enhanced with Perplexity data
            if (document.getElementById('indiaMartLink').value.trim()) scoreBreakdown.onlinePresence += 8;
            if (document.getElementById('googleBusinessLink').value.trim()) scoreBreakdown.onlinePresence += 8;
            let rating = parseFloat(document.getElementById('averageRating').value) || 0;
            
            // Boost score if AI found positive sentiment
            if (window.perplexityData && window.perplexityData.sentimentData) {
                const sentiment = window.perplexityData.sentimentData;
                if (sentiment.percentage_positive && sentiment.percentage_positive > 70) {
                    scoreBreakdown.onlinePresence += 4;
                } else if (sentiment.percentage_positive && sentiment.percentage_positive > 50) {
                    scoreBreakdown.onlinePresence += 2;
                }
            } else {
                if (rating >= 4.5) scoreBreakdown.onlinePresence += 4;
                else if (rating >= 3.5) scoreBreakdown.onlinePresence += 2;
            }

            // 5. Business History (15 points)
            let yearsInBusiness = parseInt(document.getElementById('yearsInBusiness').value) || 0;
            if (yearsInBusiness >= 5) scoreBreakdown.businessHistory += 15;
            else if (yearsInBusiness >= 3) scoreBreakdown.businessHistory += 10;
            else if (yearsInBusiness > 0) scoreBreakdown.businessHistory += 5;

            let totalScore = baseScore + Object.values(scoreBreakdown).reduce((a, b) => a + b, 0);
            totalScore = Math.min(totalScore, 100);

            // Calculate PD (Probability of Default)
            let pd = 100 - totalScore; // Simple inverse relationship
            if (totalScore >= 80) pd = Math.max(5, pd * 0.3); // Low risk: 5-15%
            else if (totalScore >= 60) pd = Math.max(15, Math.min(30, pd * 0.5)); // Medium: 15-30%
            else pd = Math.max(40, Math.min(70, pd)); // High risk: 40-70%

            // Display results
            displayResults(totalScore, pd, scoreBreakdown);
        }

        function displayResults(score, pd, breakdown) {
            document.getElementById('formContainer').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';

            // Score circle
            const circleEl = document.getElementById('scoreCircle');
            circleEl.textContent = Math.round(score);
            circleEl.className = 'score-circle';
            
            if (score >= 80) circleEl.classList.add('excellent');
            else if (score >= 60) circleEl.classList.add('good');
            else if (score >= 40) circleEl.classList.add('fair');
            else circleEl.classList.add('poor');

            // Score label
            let label = 'Score';
            if (score >= 80) label = '‚úì Excellent - Low Risk';
            else if (score >= 60) label = '‚úì Good - Medium Risk';
            else if (score >= 40) label = '‚ö† Fair - Higher Risk';
            else label = '‚úó Poor - Very High Risk';
            document.getElementById('scoreLabel').textContent = label;

            // PD score
            document.getElementById('pdScore').textContent = pd.toFixed(1) + '%';

            // Recommendation
            const recEl = document.getElementById('recommendation');
            recEl.style.display = 'block';
            if (score >= 75) {
                recEl.className = 'recommendation credit';
                recEl.innerHTML = '‚úì <strong>RECOMMENDATION: GRANT CREDIT</strong><br/>Low probability of default. This business appears creditworthy. Consider standard credit terms.';
            } else if (score >= 60) {
                recEl.className = 'recommendation credit';
                recEl.innerHTML = '‚úì <strong>RECOMMENDATION: CONDITIONAL CREDIT</strong><br/>Medium risk. Grant credit with monitoring. Consider shorter payment terms (15-30 days) and regular follow-ups.';
            } else if (score >= 45) {
                recEl.className = 'recommendation spot';
                recEl.innerHTML = '‚ö† <strong>RECOMMENDATION: SPOT PAYMENT PREFERRED</strong><br/>Higher risk. Recommend spot payment or significant prepayment (70%+). If credit given, keep credit limit low.';
            } else {
                recEl.className = 'recommendation spot';
                recEl.innerHTML = '‚úó <strong>RECOMMENDATION: SPOT PAYMENT ONLY</strong><br/>Very high risk. Do not offer credit until more verification is completed. Require 100% spot payment.';
            }

            // Overview table
            const overviewTable = document.getElementById('overviewTable');
            overviewTable.innerHTML = `
                <tr>
                    <td><strong>Contact Person</strong></td>
                    <td>${document.getElementById('contactName').value}</td>
                    <td><span class="badge verified">Verified</span></td>
                </tr>
                <tr>
                    <td><strong>Mobile Number</strong></td>
                    <td>${document.getElementById('mobileNumber').value}</td>
                    <td><span class="badge verified">Provided</span></td>
                </tr>
                <tr>
                    <td><strong>Business Name</strong></td>
                    <td>${document.getElementById('businessName').value}</td>
                    <td><span class="badge verified">Verified</span></td>
                </tr>
                <tr>
                    <td><strong>GST Number</strong></td>
                    <td>${document.getElementById('gstNumber').value}</td>
                    <td>${document.getElementById('gstCertificate').files.length > 0 ? '<span class="badge verified">Verified</span>' : '<span class="badge pending">Self-Reported</span>'}</td>
                </tr>
                <tr>
                    <td><strong>Years in Business</strong></td>
                    <td>${document.getElementById('yearsInBusiness').value || '-'}</td>
                    <td><span class="badge verified">Provided</span></td>
                </tr>
                <tr>
                    <td><strong>Annual Turnover</strong></td>
                    <td>${document.getElementById('annualTurnover').value || '-'}</td>
                    <td><span class="badge verified">Self-Reported</span></td>
                </tr>
            `;

            // Metrics breakdown
            const metricsGrid = document.getElementById('metricsBreakdown');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <h3>üìÑ Document Verification</h3>
                    <div class="value low">${breakdown.documentVerification}/25</div>
                </div>
                <div class="metric-card">
                    <h3>‚úì GST Verification</h3>
                    <div class="value ${breakdown.gstVerification >= 15 ? 'low' : 'medium'}">${breakdown.gstVerification}/20</div>
                </div>
                <div class="metric-card">
                    <h3>üè¶ Bank Details</h3>
                    <div class="value ${breakdown.bankDetails >= 15 ? 'low' : breakdown.bankDetails > 0 ? 'medium' : 'high'}">${breakdown.bankDetails}/20</div>
                </div>
                <div class="metric-card">
                    <h3>üåê Online Presence</h3>
                    <div class="value ${breakdown.onlinePresence >= 15 ? 'low' : breakdown.onlinePresence > 0 ? 'medium' : 'high'}">${breakdown.onlinePresence}/20</div>
                </div>
                <div class="metric-card">
                    <h3>üìä Business History</h3>
                    <div class="value ${breakdown.businessHistory >= 12 ? 'low' : breakdown.businessHistory > 0 ? 'medium' : 'high'}">${breakdown.businessHistory}/15</div>
                </div>
                <div class="metric-card">
                    <h3>üíØ Total Score</h3>
                    <div class="value" style="color: var(--color-primary);">${Math.round(score)}/100</div>
                </div>
            `;

            // Documentation table
            const docTable = document.getElementById('documentationTable');
            const docs = [
                { name: 'Visiting Card/ID Proof', id: 'visitingCard', impact: 'Establishes identity credibility' },
                { name: 'GST Certificate', id: 'gstCertificate', impact: 'Confirms business legality & registration' },
                { name: 'Bank Statement', id: 'bankStatement', impact: 'Shows financial activity & stability' },
                { name: 'Profile Photo', id: 'profilePhoto', impact: 'Adds personal verification layer' }
            ];
            
            docTable.innerHTML = docs.map(doc => {
                const hasFile = document.getElementById(doc.id).files.length > 0;
                return `
                    <tr>
                        <td>${doc.name}</td>
                        <td>${hasFile ? '<span class="badge verified">Uploaded</span>' : '<span class="badge missing">Missing</span>'}</td>
                        <td><small>${doc.impact}</small></td>
                    </tr>
                `;
            }).join('');

            // Detailed recommendation
            const detailedRec = document.getElementById('detailedRecommendation');
            detailedRec.innerHTML = `
                <h3>üìã Assessment Details</h3>
                <p><strong>Overall Credit Score:</strong> ${Math.round(score)}/100</p>
                <p><strong>Probability of Default (PD):</strong> ${pd.toFixed(1)}%</p>
                <p><strong>Risk Classification:</strong> ${
                    pd <= 10 ? 'Low Risk (Grade A)' :
                    pd <= 25 ? 'Low-Medium Risk (Grade B)' :
                    pd <= 40 ? 'Medium Risk (Grade C)' :
                    'High Risk (Grade D)'
                }</p>
                
                <h3 style="margin-top: 20px;">üí° Action Items</h3>
                <ul style="line-height: 1.8;">
                    ${score >= 75 ? 
                        '<li>‚úì Grant credit with standard terms (30-45 days)</li>' +
                        '<li>‚úì Monitor account quarterly</li>' +
                        '<li>‚úì Offer potential loyalty discounts for consistent payment</li>' :
                    score >= 60 ?
                        '<li>‚ö† Offer credit with shorter terms (15-30 days)</li>' +
                        '<li>‚ö† Require monthly reconciliation statements</li>' +
                        '<li>‚ö† Consider 5-10% prepayment for large orders</li>' :
                    score >= 45 ?
                        '<li>‚ö† Request 70% prepayment + 30% on delivery</li>' +
                        '<li>‚ö† Limit initial credit to ‚Çπ10,000-20,000</li>' +
                        '<li>‚ö† Require weekly check-ins initially</li>' :
                        '<li>‚úó Demand 100% spot payment only</li>' +
                        '<li>‚úó Request additional verification before credit</li>' +
                        '<li>‚úó Re-assess after 3 months of successful transactions</li>'
                    }
                </ul>

                <h3 style="margin-top: 20px;">üîê Data Verification Checklist</h3>
                <ul style="line-height: 1.8;">
                    <li>${document.getElementById('visitingCard').files.length > 0 ? '‚úì' : '‚úó'} Verify visiting card authenticity</li>
                    <li>${document.getElementById('mobileNumber').value ? '‚úì' : '‚úó'} Call mobile number to confirm business</li>
                    <li>${document.getElementById('gstNumber').value ? '‚úì' : '‚úó'} Cross-check GST number on GST portal (gst.gov.in)</li>
                    <li>${document.getElementById('bankStatement').files.length > 0 ? '‚úì' : '‚úó'} Review 3-6 months bank transaction patterns</li>
                    <li>${document.getElementById('indiaMartLink').value ? '‚úì' : '‚úó'} Check IndiaMART profile for buyer feedback & ratings</li>
                    <li>${document.getElementById('googleBusinessLink').value ? '‚úì' : '‚úó'} Review Google Maps/Business Profile ratings</li>
                </ul>
            `;

            window.scrollTo(0, 0);
        }

        function switchTab(index) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            
            // Show selected tab
            document.getElementById('tab' + index).classList.add('active');
            document.querySelectorAll('.tab-button')[index].classList.add('active');
        }

        function resetForm() {
            // Reset all inputs
            document.querySelectorAll('input, textarea, select').forEach(el => {
                el.value = '';
                el.files = undefined;
            });
            
            // Reset file buttons
            fileInputs.forEach(inputId => {
                const fileInput = document.getElementById(inputId);
                const fileButton = fileInput.parentElement.querySelector('.file-button');

                fileButton.textContent = 'üìé Choose file or drag & drop';
                fileButton.classList.remove('has-file');
            });
            
            // Hide results
            document.getElementById('formContainer').style.display = 'grid';
            document.getElementById('resultsContainer').style.display = 'none';
        }

        // Toggle results view
        function backToForm() {
            document.getElementById('formContainer').style.display = 'grid';
            document.getElementById('resultsContainer').style.display = 'none';
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
